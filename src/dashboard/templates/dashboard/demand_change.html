{% extends 'dashboard/_base.html' %}
{% block title %}Demand Changes{% endblock %}
{% block content %}
  <div class="col-md-5 min-panel-width"> <!-- Left Column -->
    <div class="panel panel-default bp-panel">
      <div class="panel-body">
        <div id="bp_chart"></div>
      </div>
    </div>

    <div class="panel panel-default alert-panel">
      <div class="panel-body">
        <div class="container-fluid alert-container">
          {% if alerts_demand %}
          <div id="alert-increase" class="col-md-6 col-sm-6 alert-col-left">
            {% for alert in alerts_demand.data.0.alerts.increase %}
            <div class="card">
              <div class="card-container">
                <div>
                  <h5 class="sc-text"><b class="sc-text">{{ alert.salesname }}</b></h5>
                </div>
                <div>
                  <h5 class="sc-text inline">{{ alert.monat }}</h5>
                  <div class="inline right">
                    <h3 class="sc-text inline">{{ alert.sc_diff_umwteuro_percent }}&euro;%</h3>
                    <div class="arrow-up inline"></div>
                  </div>

                </div>
              </div>
            </div>
            {% endfor %}
          </div>

          <div id="alert-decrease" class="col-md-6 col-sm-6 alert-col-right">
            {% for alert in alerts_demand.data.0.alerts.decrease %}
            <div class="card">
              <div class="card-container">
                <div>
                    <h5 class="sc-text"><b class="sc-text">{{ alert.salesname }}</b></h5>
                </div>
                <div>
                  <h5 class="sc-text inline sc-monat">{{ alert.monat }}</h5>
                  <div class="inline right">
                    <h3 class="sc-text inline">{{ alert.diff_umwteuro }}&euro;</h3>
                    <div class="arrow-down inline"></div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

      </div>
    </div>
  </div>
  <div class="col-md-7 min-panel-width"> <!-- Right Column -->
    <div class="panel panel-default">
      <div class="panel-body sc-panel">
        <canvas id="sc_chart"></canvas>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var records_demand = JSON.parse('{{ records_demand|safe }}');
    var bp_demand = JSON.parse('{{ bp_demand|safe }}');

  // Helper Functions
    function rgbToString(value_list, opacity) {
      return 'rgba(' + value_list[0].toString() + ',' + value_list[1].toString() + ',' + value_list[2].toString() + ',' + opacity.toString() + ')';
    }

    function sc_rgb_colormap(value) {
      var base1 = [0, 162, 189];
      var base2 = [255, 162, 189];
      // var base2 = [246, 85, 160];
      // var base1 = [227, 247, 73];
      var diff = [base2[0]-base1[0], base2[1]-base1[1], base2[2]-base1[2]];
      var result = [];

      for(var v in diff) {
        result.push(Math.round(base1[v] + Math.abs(value)/100.0*diff[v]));
      }

      return rgbToString(result, 1);
    }

    // Business Performance (D3 Circles)
    function drawBP(jsonData) {
      // BP: Acquire Data
      var bpValue = jsonData.data[0].bp.toString()+"%";
      var bpCompany = jsonData.data[0].soldtoname;
      var bpColor = "green"
      if (jsonData.data[0].bp > 100) {
        var bpColor = "red"
      }

      // BP: Render
      var bp_svgContainer = d3.select("#bp_chart")
        .attr("align", "center")
        .append("svg")
        .attr("width", 220)
        .attr("height", 220)
        .attr("align", "center");
      var outterCircle = bp_svgContainer.append("circle")
        .attr("cx", 110)
        .attr("cy", 110)
        .attr("r", 85)
        .attr("fill", bpColor);
      var innerCircle = bp_svgContainer.append("circle")
        .attr("cx", 110)
        .attr("cy", 110)
        .attr("r", 70)
        .attr("fill", "white");
      var bp_value = bp_svgContainer.append("text")
        .attr("text-anchor", "middle")
        .attr("x", 110)
        .attr("y", 120)
        .text(bpValue)
        .attr("font-family", "sans-serif")
        .attr("font-size", "30px");
      var bp_company = bp_svgContainer.append("text")
        .attr("text-anchor", "middle")
        .attr("x", 110)
        .attr("y", 20)
        .text(bpCompany)
        .attr("font-family", "sans-serif")
        .attr("font-size", "15px");
    };
    drawBP(bp_demand);

  // Structural Changes (ChartJS LineChart)
    function drawRecords(jsonData) {
      // SC: Acquire Data
      var sc_dataset = [];
      var sc_monat = jsonData.data[0].labels;

      var mean_entry = {};

      // Defination of mean dataset
      mean_entry.label = 'Mean';
      mean_entry.data = jsonData.data[0].means;
      mean_entry.fill = false;
      mean_entry.showLine = false;
      mean_entry.pointStyle = 'triangle';

      // Color mapping for mean
      var black = rgbToString([10,10,10], 1);
      var blackList = [black,black,black];
      var meanColor = rgbToString([227,243,53], 1);
      var colorList = [meanColor,meanColor,meanColor];
      mean_entry.pointBackgroundColor = colorList;
      mean_entry.pointBorderColor = blackList;
      mean_entry.pointHoverBackgroundColor = colorList;
      mean_entry.pointHoverBorderColor = blackList;
      mean_entry.pointRadius = 12;
      mean_entry.pointHoverRadius = 12;
      mean_entry.pointHitRadius = 0;

      sc_dataset.push(mean_entry);

      for (var i in jsonData.data[0].salesnames) {
        var sc_entry = {};
        var salesname_data = jsonData.data[0].salesnames[i];

        // Defination of each dataset
        sc_entry.label = salesname_data.salesname;
        sc_entry.data = salesname_data.sc;
        sc_entry.fill = false;
        sc_entry.showLine = false;
        sc_entry.pointStyle = 'circle';
        sc_entry.pointRadius = 8;
        sc_entry.pointHoverRadius = 8;
        sc_entry.pointHitRadius = 0;

        // Color mapping
        var rgb0 = sc_rgb_colormap(sc_entry.data[0]);
        var rgb1 = sc_rgb_colormap(sc_entry.data[1]);
        var rgb2 = sc_rgb_colormap(sc_entry.data[2]);
        sc_entry.pointBackgroundColor = [rgb0, rgb1, rgb2];
        sc_entry.pointBorderColor = blackList;
        sc_entry.pointHoverBackgroundColor = [rgb0, rgb1, rgb2];
        sc_entry.pointHoverBorderColor = blackList;

        sc_dataset.push(sc_entry);
      }

      // SC: Render
      // Chart.defaults.global.tooltips.displayColors = false; // turn off color box within tooltips

      var sc_LineChart = new Chart('sc_chart', {
        type: 'line',
        data: {
          // Each entry
          datasets: sc_dataset,
          labels: sc_monat,
        },
        options: {
          legend: {
            display: false,
          },
          tooltips: {
            displayColors : false,
            callbacks: {
              title: function([tooltipItem], data) {
                return data.datasets[tooltipItem.datasetIndex].label;
              },
            },
            custom: function(tooltip) {
              function getBody(bodyItem) {
                return bodyItem.lines;
              }
              if (tooltip.body) {
        				var bodyLines = tooltip.body.map(getBody);
                bodyLines[0][0] = 'SC % :' + bodyLines[0][0].split(':')[1];
                // console.log(data);
              }
            },
          },
          maintainAspectRatio: false,   // To allow specifed size : http://www.chartjs.org/docs/latest/general/responsive.html
          animation: {
            duration: 0, // general animation time
          },
          hover: {
            animationDuration: 0, // duration of animations when hovering an item
          },
          responsiveAnimationDuration: 0, // animation duration after a resize
          scales: {
            yAxes: [{
              ticks: {
                min: -100,
                max: 100,
                stepSize: 25
              },
              scaleLabel : {
                display: true,
                labelString: "Structural Change %"
              },
              gridLines : {
                // display: false,
                drawBorder: false,
                // drawOnChartArea: true,
              }
            }],
            xAxes: [{
              scaleLabel : {
                display: true,
                labelString: "MONAT"
              },
              gridLines : {
                // display: false,
                drawBorder: false,
                // lineWidth: [0,1,0],
                drawOnChartArea: true,
              }
            }]
          }
        }
      });
    };
    drawRecords(records_demand);
  </script>
{% endblock %}
