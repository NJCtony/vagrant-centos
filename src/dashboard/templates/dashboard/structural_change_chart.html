{% load static %}
<!-- ChartJS -->
<script src="{% static 'dashboard/js/Chart.bundle.min.js' %}"></script>
<div class="chart-container" style="position: relative; height:100%;">
    <canvas id="sc_chart"></canvas>
</div>
<script type="text/javascript">
  function rgbToString(value_list, opacity) {
    return 'rgba(' + value_list[0].toString() + ',' + value_list[1].toString() + ',' + value_list[2].toString() + ',' + opacity.toString() + ')';
  }

  function sc_rgb_colormap(value, alert_flag) {
    {% if records_demand %}
    return sc_demand_colormap(value, alert_flag);
    {% elif records_supply %}
    return sc_supply_colormap(value, alert_flag);
    {% endif %}
  }
  function sc_demand_colormap(value, alert_flag) {
    // var base1 = [0, 162, 189];
    // var base2 = [255, 162, 189];
    // var diff = [base2[0]-base1[0], base2[1]-base1[1], base2[2]-base1[2]];
    // var result = [];
    //
    // for(var v in diff) {
    //   result.push(Math.round(base1[v] + Math.abs(value)/100.0*diff[v]));
    // }
    // return rgbToString(result, 1);

    var color_normal = [255,245,157];
    var color_alert = [249,168,37];

    if (alert_flag == true) {
      return rgbToString(color_alert, 1);
    }
    return rgbToString(color_normal, 1);
  }
  function sc_supply_colormap(value, alert_flag) {
    // var blue = [0, 0, 128];
    // var red = [255, 0, 0];
    // if (value >= 93) {
    //   return rgbToString(blue, 1);
    // }
    // return rgbToString(red, 1);
    var color_normal = [255,245,157];
    var color_alert = [255,0,0];

    if (alert_flag == true) {
      return rgbToString(color_alert, 1);
    }
    return rgbToString(color_normal, 1);
  }

  function drawRecords(jsonData) {
    // SC: Acquire Data
    var sc_dataset = [];
    var sc_monat = jsonData.data[0].labels;
    var mean_entry = {};

    var show_labels = true;
    var step_size = 25;
    var font_size = 15;

    if (jsonData.data[0].image) {
      var chart = document.getElementById('sc_chart');
      chart.parentNode.style.height = '150px';
      chart.parentNode.style.width = '170px';
      show_labels = false;
      step_size = 100;
      font_size = 10;
    }

    {% if records_demand %}
    var yaxis_label = 'Structural Change, â‚¬%'
    var min_ticks = -100
    var max_ticks = 100
    {% elif records_supply %}
    var yaxis_label = 'Structural Change, pcs%'
    var min_ticks = 0
    var max_ticks = 100
    {% endif %}

    // Defination of mean dataset
    mean_entry.label = 'Mean';
    mean_entry.data = jsonData.data[0].means;
    mean_entry.fill = false;
    mean_entry.showLine = false;
    mean_entry.pointStyle = 'rectRot';
    mean_entry.pointBorderWidth = 2;

    // Color mapping for mean
    var border_color = rgbToString([170,170,170], 1);
    var border_color_list = [border_color,border_color,border_color];
    var black_color = rgbToString([30,30,30], 1);
    var black_color_list = [black_color,black_color,black_color];
    var meanColor = rgbToString([245,127,23], 1);
    var color_list = [meanColor,meanColor,meanColor];

    mean_entry.pointBackgroundColor = color_list;
    mean_entry.pointBorderColor = black_color;
    mean_entry.pointHoverBackgroundColor = color_list;
    mean_entry.pointHoverBorderColor = black_color;
    mean_entry.pointRadius = 12;
    mean_entry.pointHoverRadius = 12;
    mean_entry.pointHitRadius = 0;

    sc_dataset.push(mean_entry);

    for (var i in jsonData.data[0].salesnames) {
      var sc_entry = {};
      var salesname_data = jsonData.data[0].salesnames[i];

      // Defination of each dataset
      sc_entry.label = salesname_data.salesname;
      sc_entry.data = salesname_data.sc;
      sc_entry.alert_flag = salesname_data.alert_flag;
      sc_entry.fill = false;
      sc_entry.showLine = false;
      sc_entry.pointStyle = 'circle';
      sc_entry.pointRadius = 8;
      sc_entry.pointHoverRadius = 8;
      sc_entry.pointHitRadius = 0;

      // Color mapping
      var rgb0 = sc_rgb_colormap(sc_entry.data[0], sc_entry.alert_flag[0]);
      var rgb1 = sc_rgb_colormap(sc_entry.data[1], sc_entry.alert_flag[1]);
      var rgb2 = sc_rgb_colormap(sc_entry.data[2], sc_entry.alert_flag[2]);
      sc_entry.pointBackgroundColor = [rgb0, rgb1, rgb2];
      sc_entry.pointBorderColor = border_color_list;
      sc_entry.pointHoverBackgroundColor = [rgb0, rgb1, rgb2];
      sc_entry.pointHoverBorderColor = border_color_list;

      sc_dataset.push(sc_entry);
    }

    // SC: Render
    // Chart.defaults.global.tooltips.displayColors = false; // turn off color box within tooltips

    var sc_LineChart = new Chart('sc_chart', {
      type: 'line',
      data: {
        // Each entry
        datasets: sc_dataset,
        labels: sc_monat,
      },
      options: {
        layout: {
          padding: {
            top: 10,
          }
        },
        legend: {
          display: false,
        },
        tooltips: {
          displayColors : false,
          callbacks: {
            title: function([tooltipItem], data) {
              return data.datasets[tooltipItem.datasetIndex].label;
            },
          },
          custom: function(tooltip) {
            function getBody(bodyItem) {
              return bodyItem.lines;
            }
            if (tooltip.body) {
              var bodyLines = tooltip.body.map(getBody);
              bodyLines[0][0] = 'SC:' + bodyLines[0][0].split(':')[1] + '%';
              // console.log(data);
            }
          },
        },
        maintainAspectRatio: false,   // To allow specifed size : http://www.chartjs.org/docs/latest/general/responsive.html
        animation: {
          duration: 0, // general animation time,
        },
        hover: {
          animationDuration: 0, // duration of animations when hovering an item
        },
        responsiveAnimationDuration: 0, // animation duration after a resize
        scales: {
          yAxes: [{
            ticks: {
              min: min_ticks,
              max: max_ticks,
              stepSize: step_size,
              fontSize: font_size
            },
            scaleLabel : {
              display: show_labels,
              labelString: yaxis_label,
              fontSize: font_size
            },
            gridLines : {
              // display: false,
              drawBorder: false,
              // drawOnChartArea: true,
            }
          }],
          xAxes: [{
            ticks: {
              fontSize: font_size
            },
            scaleLabel : {
              display: show_labels,
              labelString: "MONAT",
              fontSize: font_size
            },
            gridLines : {
              display: false,
              drawBorder: false,
              // lineWidth: [0,1,0],
              // drawOnChartArea: true,
            }
          }]
        }
      }
    });

    return sc_LineChart;
  };

  {% if records_demand %}
  var sc_records = JSON.parse('{{ records_demand|safe }}');
  {% elif records_supply %}
  var sc_records = JSON.parse('{{ records_supply|safe }}');
  {% endif %}
  var records_chart = drawRecords(sc_records);

  // if (sc_records.data[0].image) {
  //   var chart_image = records_chart.toBase64Image();
  //   window.location = chart_image;
  // }
</script>
